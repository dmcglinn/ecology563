<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>R code for lecture 29</title>
</head>

<body>

<h2 align="center">R Code for Lecture 29 (Wednesday, December 5, 2012)</h2>
<div style="overflow:auto;"><div class="geshifilter">
  <pre class="r geshifilter-R" style="font-family:monospace;"><span style="color: #666666; font-style: italic;"># Example of reparameterizing a model to yield cell means</span>
&nbsp;
quinn <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">read.csv</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'ecol 563/quinn1.csv'</span><span style="color: #009900;">&#41;</span>
quinn<span style="">$</span>Density <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">factor</span><span style="color: #009900;">&#40;</span>quinn<span style="">$</span>Density<span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># effects model</span>
out1 <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">lm</span><span style="color: #009900;">&#40;</span>Eggs<span style="">~</span>Density<span style="">*</span><span style="">Season</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">data</span>=quinn<span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">summary</span><span style="color: #009900;">&#40;</span>out1<span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># cell means model</span>
out2 <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">lm</span><span style="color: #009900;">&#40;</span>Eggs<span style="">~</span>Density<span style="">:</span>Season<span style="">-</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">data</span>=quinn<span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># models have same AIC</span>
<span style="color: #003399; font-weight: bold;">AIC</span><span style="color: #009900;">&#40;</span>out1<span style="color: #339933;">,</span> out2<span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># cell means</span>
<span style="color: #003399; font-weight: bold;">summary</span><span style="color: #009900;">&#40;</span>out2<span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># confidence intervals for means</span>
<span style="color: #003399; font-weight: bold;">confint</span><span style="color: #009900;">&#40;</span>out2<span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># binary data example</span>
parasites <span style="">&lt;- </span><span style="color: #003399; font-weight: bold;">read.table</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'ecol 563/Parasite.txt'</span><span style="color: #339933;">,</span>header=T<span style="color: #009900;">&#41;</span>
parasites<span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="">:</span><span style="color: #cc66cc;">8</span><span style="color: #339933;">,</span><span style="color: #009900;">&#93;</span>
<span style="color: #666666; font-style: italic;"># fit model with all predictors</span>
out1 <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">glm</span><span style="color: #009900;">&#40;</span>infection<span style="">~</span>age<span style="">+</span>weight<span style="">+</span>sex<span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">data</span>=parasites<span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">family</span>=<span style="color: #003399; font-weight: bold;">binomial</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">summary</span><span style="color: #009900;">&#40;</span>out1<span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># Wald test says age is not significant, compare with LR test</span>
out2 <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">glm</span><span style="color: #009900;">&#40;</span>infection<span style="">~</span>weight<span style="">+</span>sex<span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">data</span>=parasites<span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">family</span>=<span style="color: #003399; font-weight: bold;">binomial</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">anova</span><span style="color: #009900;">&#40;</span>out2<span style="color: #339933;">,</span>out1<span style="color: #339933;">,</span>test=<span style="color: #0000ff;">'Chisq'</span><span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># odds ratios from model</span>
<span style="color: #003399; font-weight: bold;">exp</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">coef</span><span style="color: #009900;">&#40;</span>out1<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">2</span><span style="">:</span><span style="color: #cc66cc;">4</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #666666; font-style: italic;"># default plot of response is a mosaic plot</span>
<span style="color: #003399; font-weight: bold;">plot</span><span style="color: #009900;">&#40;</span>infection<span style="">~</span>weight<span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">data</span>=parasites<span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># plot binary data</span>
<span style="color: #003399; font-weight: bold;">plot</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">as.numeric</span><span style="color: #009900;">&#40;</span>infection<span style="color: #009900;">&#41;</span><span style="">-</span><span style="color: #cc66cc;">1</span><span style="">~</span>weight<span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">data</span>=parasites<span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># jitter the data and color the observations by sex</span>
<span style="color: #003399; font-weight: bold;">plot</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">jitter</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">as.numeric</span><span style="color: #009900;">&#40;</span>infection<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="">-</span><span style="color: #cc66cc;">1</span><span style=""> ~ </span><span style="color: #003399; font-weight: bold;">jitter</span><span style="color: #009900;">&#40;</span>weight<span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">data</span>=parasites<span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">col</span>=<span style="color: #003399; font-weight: bold;">as.numeric</span><span style="color: #009900;">&#40;</span>sex<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># decrease the jitter</span>
<span style="color: #003399; font-weight: bold;">plot</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">jitter</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">as.numeric</span><span style="color: #009900;">&#40;</span>infection<span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> a=<span style="color: #cc66cc;">.05</span><span style="color: #009900;">&#41;</span><span style="">-</span><span style="color: #cc66cc;">1</span><span style=""> ~ </span><span style="color: #003399; font-weight: bold;">jitter</span><span style="color: #009900;">&#40;</span>weight<span style="color: #339933;">,</span> a=<span style="color: #cc66cc;">.1</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">data</span>=parasites<span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">col</span>=<span style="color: #003399; font-weight: bold;">as.numeric</span><span style="color: #009900;">&#40;</span>sex<span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> xlab=<span style="color: #0000ff;">'weight'</span><span style="color: #339933;">,</span> ylab=<span style="color: #0000ff;">'Probability'</span><span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># model with weight and sex</span>
<span style="color: #003399; font-weight: bold;">coef</span><span style="color: #009900;">&#40;</span>out2<span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># linear predictor</span>
eta <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>x<span style="color: #339933;">,</span>sex<span style="color: #009900;">&#41;</span> <span style="color: #003399; font-weight: bold;">coef</span><span style="color: #009900;">&#40;</span>out2<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style=""> + </span><span style="color: #003399; font-weight: bold;">coef</span><span style="color: #009900;">&#40;</span>out2<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">&#93;</span><span style="">*</span>x<span style=""> + </span><span style="color: #003399; font-weight: bold;">coef</span><span style="color: #009900;">&#40;</span>out2<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">3</span><span style="color: #009900;">&#93;</span><span style="">*</span><span style="color: #009900;">&#40;</span>sex<span style="">==</span><span style="color: #0000ff;">'male'</span><span style="color: #009900;">&#41;</span>
eta<span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'female'</span><span style="color: #009900;">&#41;</span>
eta<span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'male'</span><span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># inverse logit</span>
<span style="color: #003399; font-weight: bold;">inv.logit</span> <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>eta<span style="color: #009900;">&#41;</span> <span style="color: #003399; font-weight: bold;">exp</span><span style="color: #009900;">&#40;</span>eta<span style="color: #009900;">&#41;</span><span style="">/</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1</span><span style="">+</span><span style="color: #003399; font-weight: bold;">exp</span><span style="color: #009900;">&#40;</span>eta<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># add predicted probabilities to graph</span>
<span style="color: #003399; font-weight: bold;">plot</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">jitter</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">as.numeric</span><span style="color: #009900;">&#40;</span>infection<span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>a=<span style="color: #cc66cc;">.05</span><span style="color: #009900;">&#41;</span><span style="">-</span><span style="color: #cc66cc;">1</span><span style=""> ~ </span><span style="color: #003399; font-weight: bold;">jitter</span><span style="color: #009900;">&#40;</span>weight<span style="color: #339933;">,</span>a=<span style="color: #cc66cc;">.1</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">data</span>=parasites<span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">col</span>=<span style="color: #003399; font-weight: bold;">as.numeric</span><span style="color: #009900;">&#40;</span>sex<span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> xlab=<span style="color: #0000ff;">'weight'</span><span style="color: #339933;">,</span> ylab=<span style="color: #0000ff;">'Probability'</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">curve</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">inv.logit</span><span style="color: #009900;">&#40;</span>eta<span style="color: #009900;">&#40;</span>x<span style="color: #339933;">,</span><span style="color: #0000ff;">'female'</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> add=T<span style="color: #339933;">,</span> lty=<span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">curve</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">inv.logit</span><span style="color: #009900;">&#40;</span>eta<span style="color: #009900;">&#40;</span>x<span style="color: #339933;">,</span><span style="color: #0000ff;">'male'</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> add=T<span style="color: #339933;">,</span> lty=<span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">col</span>=<span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># assess functional forms of predictors with a GAM</span>
<span style="color: #003399; font-weight: bold;">library</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">mgcv</span><span style="color: #009900;">&#41;</span>
out1.gam <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">gam</span><span style="color: #009900;">&#40;</span>infection <span style="">~</span> sex <span style="">+</span> <span style="color: #003399; font-weight: bold;">s</span><span style="color: #009900;">&#40;</span>weight<span style="color: #009900;">&#41;</span><span style="">+</span><span style="color: #003399; font-weight: bold;">s</span><span style="color: #009900;">&#40;</span>age<span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">data</span>=parasites<span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">family</span>=<span style="color: #003399; font-weight: bold;">binomial</span><span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># plot estimated smmooths</span>
<span style="color: #003399; font-weight: bold;">plot</span><span style="color: #009900;">&#40;</span>out1.gam<span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># plot smooth for age</span>
<span style="color: #003399; font-weight: bold;">plot</span><span style="color: #009900;">&#40;</span>out1.gam<span style="color: #339933;">,</span> select=<span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">abline</span><span style="color: #009900;">&#40;</span>h=<span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span> lty=<span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">col</span>=<span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># plot smooth for weight</span>
<span style="color: #003399; font-weight: bold;">plot</span><span style="color: #009900;">&#40;</span>out1.gam<span style="color: #339933;">,</span> select=<span style="color: #cc66cc;">1</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">abline</span><span style="color: #009900;">&#40;</span>h=<span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span> lty=<span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">col</span>=<span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># add a quadratic term in age</span>
out3 <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">glm</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">formula</span> = infection <span style="">~</span> age <span style="">+</span><span style="color: #003399; font-weight: bold;">I</span><span style="color: #009900;">&#40;</span>age<span style="">^</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span> <span style="">+</span> weight <span style="">+</span> sex<span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">family</span> = <span style="color: #003399; font-weight: bold;">binomial</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">data</span>=parasites<span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># LR test for quadatic age</span>
<span style="color: #003399; font-weight: bold;">anova</span><span style="color: #009900;">&#40;</span>out1<span style="color: #339933;">,</span> out3<span style="color: #339933;">,</span> test=<span style="color: #0000ff;">'Chisq'</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">summary</span><span style="color: #009900;">&#40;</span>out3<span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># re-examine smooth for weight with model containing quadratic age</span>
out1.gam <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">gam</span><span style="color: #009900;">&#40;</span>infection <span style="">~</span> sex <span style="">+</span> <span style="color: #003399; font-weight: bold;">s</span><span style="color: #009900;">&#40;</span>weight<span style="color: #009900;">&#41;</span> <span style="">+</span> age <span style="">+</span> <span style="color: #003399; font-weight: bold;">I</span><span style="color: #009900;">&#40;</span>age<span style="">^</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">data</span>=parasites<span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">family</span>=<span style="color: #003399; font-weight: bold;">binomial</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">plot</span><span style="color: #009900;">&#40;</span>out1.gam<span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># fit breakpoint model for weight with a break point of 8</span>
out4 <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">glm</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">formula</span> = infection <span style="">~</span> age <span style="">+</span> <span style="color: #003399; font-weight: bold;">I</span><span style="color: #009900;">&#40;</span>age<span style="">^</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span> <span style="">+</span> sex <span style="">+</span> <span style="color: #003399; font-weight: bold;">I</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span>weight<span style="">&gt;</span><span style="color: #cc66cc;">8</span><span style="color: #009900;">&#41;</span><span style="">*</span><span style="color: #009900;">&#40;</span>weight<span style="">-</span><span style="color: #cc66cc;">8</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">family</span> = <span style="color: #003399; font-weight: bold;">binomial</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">data</span>=parasites<span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># this is an improvement</span>
<span style="color: #003399; font-weight: bold;">AIC</span><span style="color: #009900;">&#40;</span>out3<span style="color: #339933;">,</span> out4<span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">summary</span><span style="color: #009900;">&#40;</span>out4<span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># possible choices for break points</span>
<span style="color: #003399; font-weight: bold;">sort</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">unique</span><span style="color: #009900;">&#40;</span>parasites<span style="">$</span>weight<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>
cvec <span style="">&lt;-</span> <span style="color: #cc66cc;">3</span><span style="">:</span><span style="color: #cc66cc;">16</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># function to fit model at specific break points</span>
c.func <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">c</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
mymodel <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">glm</span><span style="color: #009900;">&#40;</span>infection<span style=""> ~</span> sex <span style="">+</span> age <span style="">+</span> <span style="color: #003399; font-weight: bold;">I</span><span style="color: #009900;">&#40;</span>age<span style="">^</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span> <span style="">+</span> <span style="color: #003399; font-weight: bold;">I</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span>weight<span style="">&gt;=</span><span style="color: #003399; font-weight: bold;">c</span><span style="color: #009900;">&#41;</span><span style="">*</span><span style="color: #009900;">&#40;</span>weight<span style="">-</span><span style="color: #003399; font-weight: bold;">c</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">data</span>=parasites<span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">family</span>=<span style="color: #003399; font-weight: bold;">binomial</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">c</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">c</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">logLik</span><span style="color: #009900;">&#40;</span>mymodel<span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">AIC</span><span style="color: #009900;">&#40;</span>mymodel<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># run function</span>
<span style="color: #003399; font-weight: bold;">sapply</span><span style="color: #009900;">&#40;</span>cvec<span style="color: #339933;">,</span> c.func<span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># best break point is c = 12</span>
out6 <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">glm</span><span style="color: #009900;">&#40;</span>infection <span style="">~</span> sex <span style="">+</span> age <span style="">+</span> <span style="color: #003399; font-weight: bold;">I</span><span style="color: #009900;">&#40;</span>age<span style="">^</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span> <span style="">+</span> <span style="color: #003399; font-weight: bold;">I</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span>weight<span style="">&gt;=</span><span style="color: #cc66cc;">12</span><span style="color: #009900;">&#41;</span><span style="">*</span><span style="color: #009900;">&#40;</span>weight<span style="">-</span><span style="color: #cc66cc;">12</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">data</span>=parasites<span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">family</span>=<span style="color: #003399; font-weight: bold;">binomial</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">summary</span><span style="color: #009900;">&#40;</span>out6<span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># compare models</span>
<span style="color: #003399; font-weight: bold;">AIC</span><span style="color: #009900;">&#40;</span>out1<span style="color: #339933;">, </span>out3<span style="color: #339933;">,</span> out6<span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># comparison is unfair because we're not counting break point as a parameter</span>
my.aic <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">AIC</span><span style="color: #009900;">&#40;</span>out1<span style="color: #339933;">,</span> out3<span style="color: #339933;">, </span>out6<span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># add to AIC</span>
my.aic<span style="color: #009900;">&#91;</span><span style="color: #339933;">,</span><span style="color: #0000ff;">&quot;AIC&quot;</span><span style="color: #009900;">&#93;</span> <span style="">&lt;-</span> my.aic<span style="color: #009900;">&#91;</span><span style="color: #339933;">,</span><span style="color: #0000ff;">&quot;AIC&quot;</span><span style="color: #009900;">&#93;</span><span style="">+</span><span style="color: #003399; font-weight: bold;">c</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># add parameter</span>
my.aic<span style="color: #009900;">&#91;</span><span style="color: #339933;">,</span><span style="color: #0000ff;">&quot;df&quot;</span><span style="color: #009900;">&#93;</span> <span style="">&lt;-</span> my.aic<span style="color: #009900;">&#91;</span><span style="color: #339933;">,</span><span style="color: #0000ff;">&quot;df&quot;</span><span style="color: #009900;">&#93;</span><span style="">+</span><span style="color: #003399; font-weight: bold;">c</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;">#### model calibration ###########</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># predicted probabilities</span>
<span style="color: #003399; font-weight: bold;">round</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">fitted</span><span style="color: #009900;">&#40;</span>out6<span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">3</span><span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># decision rule: classify as infected if p &gt; 0.5</span>
<span style="color: #666666; font-style: italic;"># confusion matrix</span>
tab0 <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">table</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">fitted</span><span style="color: #009900;">&#40;</span>out6<span style="color: #009900;">&#41;</span><span style="">&gt;</span><span style="color: #cc66cc;">0.5</span><span style="color: #339933;">,</span> parasites<span style="">$</span>infection<span style="color: #009900;">&#41;</span>
tab0
<span style="color: #666666; font-style: italic;"># calculate specificity and sensitivity</span>
<span style="color: #003399; font-weight: bold;">diag</span><span style="color: #009900;">&#40;</span>tab0<span style="color: #009900;">&#41;</span><span style="">/</span>apply<span style="color: #009900;">&#40;</span>tab0<span style="color: #339933;">,</span><span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span><span style="color: #003399; font-weight: bold;">sum</span><span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># function to fit breakpoint model</span>
precision <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">c</span><span style="color: #339933;">,</span>model<span style="color: #339933;">,</span> response<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
tab0 <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">table</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">fitted</span><span style="color: #009900;">&#40;</span>model<span style="color: #009900;">&#41;</span><span style="">&gt;=</span><span style="color: #003399; font-weight: bold;">c</span><span style="color: #339933;">,</span> response<span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">rownames</span><span style="color: #009900;">&#40;</span>tab0<span style="color: #009900;">&#41;</span><span style="">&lt;-</span><span style="color: #003399; font-weight: bold;">c</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'-'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'+'</span><span style="color: #009900;">&#41;</span>
out <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">diag</span><span style="color: #009900;">&#40;</span>tab0<span style="color: #009900;">&#41;</span><span style="">/</span>apply<span style="color: #009900;">&#40;</span>tab0<span style="color: #339933;">,</span> <span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">sum</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">names</span><span style="color: #009900;">&#40;</span>out<span style="color: #009900;">&#41;</span> <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">c</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'specificity'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'sensitivity'</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">list</span><span style="color: #009900;">&#40;</span>tab0<span style="color: #339933;">,</span> out<span style="color: #009900;">&#41;</span>
<span style="color: #009900;">&#125;</span>
precision<span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">.5</span><span style="color: #339933;">,</span> out6<span style="color: #339933;">,</span> parasites<span style="">$</span>infection<span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># obtaining specificity and sensitivity</span>
<span style="color: #003399; font-weight: bold;">library</span><span style="color: #009900;">&#40;</span><span style="">ROCR</span><span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># create prediction object</span>
pred1 <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">prediction</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">fitted</span><span style="color: #009900;">&#40;</span>out6<span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> parasites<span style="">$</span>infection<span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># extract true positive and true negative rates</span>
stats1 <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">performance</span><span style="color: #009900;">&#40;</span>pred1<span style="color: #339933;">,</span> <span style="color: #0000ff;">'tpr'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'tnr'</span><span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># the result is an S4 object</span>
<span style="color: #003399; font-weight: bold;">str</span><span style="color: #009900;">&#40;</span>stats1<span style="color: #009900;">&#41;</span>
stats1<span style="">@</span>y.values
stats1<span style="">@</span>x.values
stats1<span style="">@</span>alpha.values
<span style="color: #666666; font-style: italic;"># change infinite value to 1</span>
stats1<span style="">@</span>alpha.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="">&lt;-</span><span style="color: #cc66cc;">1</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># plot specificity</span>
<span style="color: #003399; font-weight: bold;">plot</span><span style="color: #009900;">&#40;</span>stats1<span style="">@</span>alpha.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> stats1<span style="">@</span>x.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> type=<span style="color: #0000ff;">'s'</span><span style="color: #339933;">,</span> xlab=<span style="color: #0000ff;">'cut-off'</span><span style="color: #339933;">,</span> ylab=<span style="color: #0000ff;">'Classification rate'</span><span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># add sensitivity</span>
<span style="color: #003399; font-weight: bold;">lines</span><span style="color: #009900;">&#40;</span>stats1<span style="">@</span>alpha.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> stats1<span style="">@</span>y.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> type=<span style="color: #0000ff;">'s'</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">col</span>=<span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">legend</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'right'</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">c</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'specificity'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'sensitivity'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">col</span>=<span style="color: #cc66cc;">1</span><span style="">:</span><span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span> lty=<span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span> bty=<span style="color: #0000ff;">'n'</span><span style="color: #339933;">,</span> cex=<span style="color: #cc66cc;">.9</span><span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># determinine minimized difference threshold (MDT)</span>
<span style="color: #003399; font-weight: bold;">which.min</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">abs</span><span style="color: #009900;">&#40;</span>stats1<span style="">@</span>x.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="">-</span>stats1<span style="">@</span>y.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>
stats1<span style="">@</span>alpha.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">26</span><span style="color: #009900;">&#93;</span>
precision</<span style="color: #009900;">&#40;</span>stats1<span style="">@</span>alpha.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">26</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> out6<span style="color: #339933;">,</span>parasites<span style="">$</span>infection<span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">abline</span><span style="color: #009900;">&#40;</span>v=stats1<span style="">@</span>alpha.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">26</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> lty=<span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">col</span>=<span style="color: #cc66cc;">4</span><span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># determinine maximized sum threshold (MST)</span>
<span style="color: #003399; font-weight: bold;">which.max</span><span style="color: #009900;">&#40;</span>stats1<span style="">@</span>x.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="">+</span>stats1<span style="">@</span>y.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span>
stats1<span style="">@</span>alpha.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">37</span><span style="color: #009900;">&#93;</span>
<span style="color: #003399; font-weight: bold;">abline</span><span style="color: #009900;">&#40;</span>v=stats1<span style="">@</span>alpha.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">37</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">col</span>=<span style="color: #cc66cc;">3</span><span style="color: #339933;">,</span> lty=<span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;">############ ROC curves ##########</span>
&nbsp;
stats1a <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">performance</span><span style="color: #009900;">&#40;</span>pred1<span style="color: #339933;">,</span><span style="color: #0000ff;">'tpr'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'fpr'</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">str</span><span style="color: #009900;">&#40;</span>stats1a<span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">plot</span><span style="color: #009900;">&#40;</span>stats1a<span style="">@</span>x.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> stats1a<span style="">@</span>y.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> type=<span style="color: #0000ff;">'s'</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">col</span>=<span style="color: #0000ff;">'grey70'</span><span style="color: #339933;">,</span> lwd=<span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span> xlab=<span style="color: #0000ff;">'FPR'</span><span style="color: #339933;">,</span> ylab=<span style="color: #0000ff;">'TPR'</span><span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># obtain TPR and FPR of a second model</span>
pred2 <span style="">&lt;- </span><span style="color: #003399; font-weight: bold;">prediction</span><span style="color: #009900;">&#40;</span><span style="color: #003399; font-weight: bold;">fitted</span><span style="color: #009900;">&#40;</span>out1<span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> parasites<span style="">$</span>infection<span style="color: #009900;">&#41;</span>
stats2a <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">performance</span><span style="color: #009900;">&#40;</span>pred2<span style="color: #339933;">,</span><span style="color: #0000ff;">'tpr'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'fpr'</span><span style="color: #009900;">&#41;</span>
<span style="color: #666666; font-style: italic;"># add ROC curve to previous graph</span>
<span style="color: #003399; font-weight: bold;">lines</span><span style="color: #009900;">&#40;</span>stats2a<span style="">@</span>x.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> stats2a<span style="">@</span>y.values<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> type=<span style="color: #0000ff;">'s'</span><span style="color: #339933;">,</span> <span style="color: #003399; font-weight: bold;">col</span>=<span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span>
&nbsp;
<span style="color: #666666; font-style: italic;">##### Area under the curve ######</span>
stats1b <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">performance</span><span style="color: #009900;">&#40;</span>pred1<span style="color: #339933;">,</span> <span style="color: #0000ff;">'auc'</span><span style="color: #009900;">&#41;</span>
stats2b <span style="">&lt;-</span> <span style="color: #003399; font-weight: bold;">performance</span><span style="color: #009900;">&#40;</span>pred2<span style="color: #339933;">,</span> <span style="color: #0000ff;">'auc'</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">str</span><span style="color: #009900;">&#40;</span>stats1b<span style="color: #009900;">&#41;</span>
stats1b<span style="">@</span>y.values
stats2b<span style="">@</span>y.values
&nbsp;
<span style="color: #666666; font-style: italic;">#### 10-fold cross-validation of binary model ######</span>
<span style="color: #003399; font-weight: bold;">library</span><span style="color: #009900;">&#40;</span><span style="">DAAG</span><span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">cv.binary</span><span style="color: #009900;">&#40;</span>out6<span style="color: #009900;">&#41;</span>
<span style="color: #003399; font-weight: bold;">cv.binary</span><span style="color: #009900;">&#40;</span>out1<span style="color: #009900;">&#41;</span></pre></div></div><p>Created by Pretty R at inside-R.org</p>


</body>
</html>
